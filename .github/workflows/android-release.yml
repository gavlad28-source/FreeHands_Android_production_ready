name: Android Release Build & Deploy

on:
  workflow_dispatch:
  push:
    tags: [ 'v*' ]

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # (–ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ) –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ—Å—Ç—å –Ω—É–∂–Ω—ã–µ SDK
      - name: Install Android SDK components
        run: |
          yes | sudo ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --licenses
          sudo ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Decode keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > my-release-key.jks

      - name: Decode Play service account JSON
        run: echo "${{ secrets.PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}" | base64 --decode > service-account.json

      - name: Grant execute to Gradlew
        run: chmod +x FreeHands_Android_production_with_wrapper/gradlew

      # üîé –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤/—Ñ–∞–π–ª–æ–≤ (–±–µ–∑ —É—Ç–µ—á–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π)
      - name: Verify secrets/files presence
        run: |
          [ -s my-release-key.jks ] && echo "keystore: OK" || (echo "keystore missing" && exit 1)
          [ -s service-account.json ] && echo "service account json: OK" || (echo "service account json missing" && exit 1)
          test -n "${{ secrets.KEYSTORE_PASSWORD }}" && echo "KEYSTORE_PASSWORD: OK" || (echo "KEYSTORE_PASSWORD missing" && exit 1)
          test -n "${{ secrets.KEY_ALIAS }}" && echo "KEY_ALIAS: OK" || (echo "KEY_ALIAS missing" && exit 1)
          test -n "${{ secrets.KEY_PASSWORD }}" && echo "KEY_PASSWORD: OK" || (echo "KEY_PASSWORD missing" && exit 1)

      # üß™ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–∫–∏–µ publish-—Ç–∞—Å–∫–∏ —Ä–µ–∞–ª—å–Ω–æ –µ—Å—Ç—å —É –º–æ–¥—É–ª—è
      - name: List publish tasks
        run: ./FreeHands_Android_production_with_wrapper/gradlew -p ./FreeHands_Android_production_with_wrapper :app:tasks --all | grep -i publish || true

      # üèóÔ∏è –°–±–æ—Ä–∫–∞ bundle —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
      - name: Build AAB (bundleRelease)
        env:
          KEYSTORE_FILE: my-release-key.jks
        run: ./FreeHands_Android_production_with_wrapper/gradlew -p ./FreeHands_Android_production_with_wrapper :app:bundleRelease --stacktrace --info --no-daemon

      # ‚¨ÜÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å AAB –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–∞–∂–µ –ø—Ä–∏ —Å–±–æ–µ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
      - name: Upload AAB artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: FreeHands_Android_production_with_wrapper/FreeHands_Android_production_fixed/build/outputs/bundle/release/*.aab

      # üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Google Play (internal track)
      - name: Publish to Play (internal)
        env:
          KEYSTORE_FILE: my-release-key.jks
          PLAY_SERVICE_ACCOUNT_JSON: service-account.json
        run: ./FreeHands_Android_production_with_wrapper/gradlew -p ./FreeHands_Android_production_with_wrapper :app:publishRelease --stacktrace --info --no-daemon
